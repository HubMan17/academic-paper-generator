<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Test - Academic Paper Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Document Pipeline Test</h1>
        <p class="text-gray-600 mb-6">Этап 4: генерация документа с секциями</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Controls -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Controls</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Document ID</label>
                        <input type="text" id="documentId" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono" placeholder="UUID">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Profile</label>
                        <select id="profileSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="fast">fast</option>
                            <option value="default" selected>default</option>
                            <option value="heavy">heavy</option>
                        </select>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="runDocument()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">
                            Run Document
                        </button>
                        <button onclick="resumeDocument()" class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700 text-sm">
                            Resume
                        </button>
                    </div>

                    <button onclick="loadStatus()" class="w-full bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 text-sm">
                        Refresh Status
                    </button>
                </div>

                <div id="statusInfo" class="mt-4 text-sm">
                    <p class="text-gray-500">Enter Document ID and click Refresh</p>
                </div>
            </div>

            <!-- Sections Table -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Sections</h2>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left">Key</th>
                                <th class="px-3 py-2 text-left">Title</th>
                                <th class="px-3 py-2 text-center">Context</th>
                                <th class="px-3 py-2 text-center">Section</th>
                                <th class="px-3 py-2 text-center">Summary</th>
                                <th class="px-3 py-2 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sectionsTable" class="divide-y">
                            <tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Results Tabs -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <div class="border-b border-gray-200 mb-4">
                <nav class="flex space-x-4">
                    <button onclick="showResultTab('draft')" id="rtab-draft" class="result-tab px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600">
                        Document Draft
                    </button>
                    <button onclick="showResultTab('toc')" id="rtab-toc" class="result-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        TOC
                    </button>
                    <button onclick="showResultTab('quality')" id="rtab-quality" class="result-tab px-4 py-2 font-medium text-gray-500 hover:text-gray-700">
                        Quality Report
                    </button>
                </nav>
            </div>

            <div id="result-draft" class="result-content">
                <div id="draftContent" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-sm">No document draft yet</p>
                </div>
            </div>

            <div id="result-toc" class="result-content hidden">
                <div id="tocContent" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-sm">No TOC yet</p>
                </div>
            </div>

            <div id="result-quality" class="result-content hidden">
                <div id="qualityContent" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-sm">No quality report yet</p>
                </div>
            </div>
        </div>

        <!-- Loading/Error -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                    <span id="loadingText">Processing...</span>
                </div>
            </div>
        </div>

        <div id="errorBanner" class="hidden fixed bottom-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg max-w-md">
            <span id="errorText"></span>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/projects';

        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorBanner').classList.remove('hidden');
            setTimeout(() => document.getElementById('errorBanner').classList.add('hidden'), 5000);
        }

        function getDocumentId() {
            return document.getElementById('documentId').value.trim();
        }

        function getProfile() {
            return document.getElementById('profileSelect').value;
        }

        function showResultTab(name) {
            document.querySelectorAll('.result-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.result-tab').forEach(el => {
                el.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                el.classList.add('text-gray-500');
            });
            document.getElementById('result-' + name).classList.remove('hidden');
            const tab = document.getElementById('rtab-' + name);
            tab.classList.remove('text-gray-500');
            tab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        }

        async function runDocument() {
            const docId = getDocumentId();
            if (!docId) { showError('Enter Document ID'); return; }

            showLoading('Starting document generation...');
            try {
                const resp = await fetch(`${API_BASE}/documents/${docId}/pipeline/run/?step=document&profile=${getProfile()}`, { method: 'POST' });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('statusInfo').innerHTML = `<p class="text-green-600">Job queued: ${data.job_id}</p>`;
                } else {
                    showError(data.error || 'Failed');
                }
            } catch (e) {
                showError(e.message);
            } finally {
                hideLoading();
            }
        }

        async function resumeDocument() {
            const docId = getDocumentId();
            if (!docId) { showError('Enter Document ID'); return; }

            showLoading('Resuming document generation...');
            try {
                const resp = await fetch(`${API_BASE}/documents/${docId}/pipeline/run/?step=resume&profile=${getProfile()}`, { method: 'POST' });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('statusInfo').innerHTML = `<p class="text-yellow-600">Resume queued: ${data.job_id}</p>`;
                } else {
                    showError(data.error || 'Failed');
                }
            } catch (e) {
                showError(e.message);
            } finally {
                hideLoading();
            }
        }

        async function runSection(key) {
            const docId = getDocumentId();
            if (!docId) { showError('Enter Document ID'); return; }

            showLoading(`Regenerating section ${key}...`);
            try {
                const resp = await fetch(`${API_BASE}/documents/${docId}/pipeline/run/?step=section&key=${key}&profile=${getProfile()}&force=1`, { method: 'POST' });
                const data = await resp.json();
                if (resp.ok) {
                    document.getElementById('statusInfo').innerHTML = `<p class="text-blue-600">Section ${key} queued: ${data.job_id}</p>`;
                } else {
                    showError(data.error || 'Failed');
                }
            } catch (e) {
                showError(e.message);
            } finally {
                hideLoading();
            }
        }

        async function loadStatus() {
            const docId = getDocumentId();
            if (!docId) { showError('Enter Document ID'); return; }

            showLoading('Loading status...');
            try {
                const resp = await fetch(`${API_BASE}/documents/${docId}/pipeline/status/`);
                const data = await resp.json();

                if (!resp.ok) {
                    showError(data.error || 'Failed to load status');
                    return;
                }

                document.getElementById('statusInfo').innerHTML = `
                    <p><strong>Status:</strong> ${data.document_status}</p>
                    <p>Outline: ${data.has_outline ? '✓' : '✗'} |
                       Draft: ${data.has_draft ? '✓' : '✗'} |
                       TOC: ${data.has_toc ? '✓' : '✗'} |
                       Quality: ${data.has_quality_report ? '✓' : '✗'}</p>
                `;

                const tbody = document.getElementById('sectionsTable');
                if (data.sections && data.sections.length > 0) {
                    tbody.innerHTML = data.sections.map(s => `
                        <tr>
                            <td class="px-3 py-2 font-mono text-xs">${s.key}</td>
                            <td class="px-3 py-2">${s.title}</td>
                            <td class="px-3 py-2 text-center">${s.has_context_pack ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">✗</span>'}</td>
                            <td class="px-3 py-2 text-center">${s.has_section ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">✗</span>'}</td>
                            <td class="px-3 py-2 text-center">${s.has_summary ? '<span class="text-green-600">✓</span>' : '<span class="text-gray-400">✗</span>'}</td>
                            <td class="px-3 py-2 text-center">
                                <button onclick="runSection('${s.key}')" class="text-blue-600 hover:text-blue-800 text-xs">Regen</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">No sections</td></tr>';
                }

                await Promise.all([loadDraft(docId), loadToc(docId), loadQuality(docId)]);

            } catch (e) {
                showError(e.message);
            } finally {
                hideLoading();
            }
        }

        async function loadDraft(docId) {
            try {
                const resp = await fetch(`${API_BASE}/documents/${docId}/pipeline/draft/`);
                if (resp.ok) {
                    const data = await resp.json();
                    const sections = data.data?.sections || [];
                    let html = '';
                    for (const s of sections) {
                        html += `<h2 class="text-lg font-bold mt-4">${s.title}</h2>`;
                        html += `<p class="text-xs text-gray-500">${s.word_count} words</p>`;
                        html += `<div class="prose prose-sm max-w-none">${marked ? marked.parse(s.content_md) : s.content_md}</div>`;
                    }
                    document.getElementById('draftContent').innerHTML = html || '<p class="text-gray-500">Empty draft</p>';
                }
            } catch (e) {
                console.error('Failed to load draft:', e);
            }
        }

        async function loadToc(docId) {
            try {
                const resp = await fetch(`${API_BASE}/documents/${docId}/pipeline/toc/`);
                if (resp.ok) {
                    const data = await resp.json();
                    const items = data.data?.items || [];
                    let html = '<ul class="list-disc pl-4">';
                    for (const item of items) {
                        const indent = (item.level - 1) * 16;
                        html += `<li style="margin-left: ${indent}px">${item.title}</li>`;
                    }
                    html += '</ul>';
                    document.getElementById('tocContent').innerHTML = html || '<p class="text-gray-500">Empty TOC</p>';
                }
            } catch (e) {
                console.error('Failed to load TOC:', e);
            }
        }

        async function loadQuality(docId) {
            try {
                const resp = await fetch(`${API_BASE}/documents/${docId}/pipeline/quality/`);
                if (resp.ok) {
                    const data = await resp.json();
                    const q = data.data || {};
                    let html = `<p class="font-bold ${data.passed ? 'text-green-600' : 'text-red-600'}">${data.passed ? 'PASSED' : 'FAILED'}</p>`;
                    html += `<p>Errors: ${data.error_count}, Warnings: ${data.warning_count}</p>`;
                    html += `<p>Total words: ${q.stats?.total_words || 0}</p>`;

                    if (q.errors?.length > 0) {
                        html += '<h3 class="font-bold text-red-600 mt-2">Errors:</h3><ul class="list-disc pl-4">';
                        for (const e of q.errors) {
                            html += `<li>[${e.code}] ${e.message}</li>`;
                        }
                        html += '</ul>';
                    }

                    if (q.warnings?.length > 0) {
                        html += '<h3 class="font-bold text-yellow-600 mt-2">Warnings:</h3><ul class="list-disc pl-4">';
                        for (const w of q.warnings) {
                            html += `<li>[${w.code}] ${w.message}</li>`;
                        }
                        html += '</ul>';
                    }

                    document.getElementById('qualityContent').innerHTML = html;
                }
            } catch (e) {
                console.error('Failed to load quality:', e);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>
